<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teachable Machine Real-Time Prediction</title>

  <!-- TensorFlow.js CDN -->

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f7f9ff; padding: 20px; }
    #webcam-container { margin: 20px auto; }
    #label-container { margin-top: 10px; font-size: 18px; font-weight: bold; }
    video { border: 1px solid #ccc; }
  </style>

</head>
<body>
  <h1>Teachable Machine Real-Time Prediction</h1>
  <div id="webcam-container">
    <video id="webcam" autoplay playsinline width="200" height="200"></video>
  </div>
  <div id="label-container">Loading model...</div>

  <script>
    const MODEL_URL = "model/model.json"; // 모델 폴더 이름과 일치
    let model;
    let webcamElement = document.getElementById("webcam");
    let labelContainer = document.getElementById("label-container");

    async function init() {
      try {
        // 모델 로드
        model = await tf.loadGraphModel(MODEL_URL);
        labelContainer.innerText = "Model loaded!";

        // 웹캠 연결
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        webcamElement.srcObject = stream;

        // 예측 루프 시작
        webcamElement.onloadeddata = () => {
          requestAnimationFrame(loop);
        };
      } catch (error) {
        console.error(error);
        labelContainer.innerText = "Error loading model.";
      }
    }

    async function loop() {
      if (!model) return;

      // 웹캠에서 프레임 가져오기
      const img = tf.browser.fromPixels(webcamElement).resizeNearestNeighbor([224, 224]).toFloat().expandDims();
      
      // 예측
      const prediction = await model.predict(img);
      const data = prediction.dataSync(); // 예측 결과 가져오기
      const maxIdx = data.indexOf(Math.max(...data));

      labelContainer.innerText = `Prediction: Class ${maxIdx} - ${ (data[maxIdx]*100).toFixed(2) }%`;

      img.dispose(); // 메모리 해제
      requestAnimationFrame(loop);
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>

</body>
</html>

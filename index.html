<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TeachableMachine Image Model</title>
  <style>
    body { background:#f7f9ff; font-family:Arial; text-align:center; padding:20px; }
    #webcam-container canvas { border-radius:10px; }
    .btn { padding:10px 16px; font-size:16px; border:none; border-radius:8px; cursor:pointer; margin:8px; }
    .webcam-btn { background:#4a6cff; color:#fff; }
    .file-btn { background:#5cb85c; color:#fff; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>
<body>

  <h2>Teachable Machine 이미지 분류 (웹캠 + 파일 업로드)</h2>

  <button class="btn webcam-btn" onclick="initWebcam()">웹캠 시작</button>
  <input type="file" accept="image/*" class="btn file-btn" onchange="predictFile(event)">

  <div id="webcam-container"></div>
  <div id="image-container"></div>
  <div id="label-container"></div>

  <script>
    const modelURL = "model.json";
    const metadataURL = "metadata.json";

    let model, webcam, labelContainer, maxPredictions;

    async function loadModel() {
      if (!model) {
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "";
        for (let i = 0; i < maxPredictions; i++) {
          let div = document.createElement("div");
          labelContainer.appendChild(div);
        }
      }
    }

    // ----- 웹캠 모드 -----
    async function initWebcam() {
      await loadModel();

      if (webcam) {
        webcam.stop();
      }

      const flip = true;
      webcam = new tmImage.Webcam(300, 300, flip);
      await webcam.setup();
      await webcam.play();
      window.requestAnimationFrame(loop);

      document.getElementById("webcam-container").innerHTML = "";
      document.getElementById("webcam-container").appendChild(webcam.canvas);
      document.getElementById("image-container").innerHTML = "";
    }

    async function loop() {
      webcam.update();
      await predict(webcam.canvas);
      window.requestAnimationFrame(loop);
    }

    // ----- 파일 업로드 모드 -----
    async function predictFile(event) {
      await loadModel();

      if (webcam) webcam.stop();

      const file = event.target.files[0];
      const img = document.createElement("img");
      img.src = URL.createObjectURL(file);
      img.width = 300;

      img.onload = async () => {
        document.getElementById("image-container").innerHTML = "";
        document.getElementById("image-container").appendChild(img);
        document.getElementById("webcam-container").innerHTML = "";

        await predict(img);
      };
    }

    // ----- 공통 예측 함수 -----
    async function predict(input) {
      const prediction = await model.predict(input);

      for (let i = 0; i < maxPredictions; i++) {
        const className = prediction[i].className;
        const prob = (prediction[i].probability * 100).toFixed(1);
        labelContainer.childNodes[i].innerHTML = `${className}: ${prob}%`;
      }
    }
  </script>

</body>
</html>

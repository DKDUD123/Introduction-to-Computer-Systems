<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>AI ê°ì²´ ì¸ì‹ â€” ë¹ ë¥¸ ë¡œë”© ë²„ì „</title>
<style>
  body{background:#f7f9ff;font-family:Arial,Helvetica,sans-serif;padding:28px;text-align:center;}
  .card{width:460px;margin:0 auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(20,30,70,0.08);}
  h1{margin:0;font-size:22px;color:#24324a}
  .controls{margin-top:12px}
  button{background:#4b6df6;color:#fff;border:none;padding:10px 14px;border-radius:8px;margin:6px;cursor:pointer}
  #webcam-container, #preview-img{margin-top:16px}
  #label-container div{font-weight:700;margin:6px;padding:8px;border-radius:8px;background:#eef2ff}
  #status{margin-top:12px;color:#2b3a55;font-weight:600}
  .spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(0,0,0,0.08);border-top-color:#4b6df6;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="card">
    <h1>AI ê°ì²´ ì¸ì‹ (ë¦¬ëª¨ì»¨ / ë²„ì¦ˆ / ë³´ì¡°ë°°í„°ë¦¬)</h1>

    <div class="controls">
      <button id="btn-start">ğŸ“¸ ì›¹ìº  ì‹œì‘</button>
      <button id="btn-upload">ğŸ–¼ ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
      <input type="file" id="imgFile" accept="image/*" style="display:none">
    </div>

    <div id="status">ì¤€ë¹„ë¨</div>

    <div id="webcam-container"></div>
    <img id="preview-img" style="width:280px;border-radius:8px;display:none" />

    <div id="label-container"></div>
  </div>

<script>
/*
  ê°œì„  í¬ì¸íŠ¸:
  - ë¼ì´ë¸ŒëŸ¬ë¦¬( tf + tmImage )ëŠ” ì‚¬ìš©ìê°€ ì•¡ì…˜í•  ë•Œë§Œ ë™ì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜´ (ì§€ì—°ë¡œë”©)
  - ëª¨ë¸ì€ í•œ ë²ˆë§Œ ë¡œë“œí•˜ê³  ì¬ì‚¬ìš©
  - webcam í•´ìƒë„ë¥¼ ë‚®ì¶”ê³  ì—ëŸ¬í•¸ë“¤ë§ ì¶”ê°€
*/

const TM_URL = "https://teachablemachine.withgoogle.com/models/YCegcUTGC/";
let model = null;
let tmImageLibLoaded = false;
let webcam = null;
let maxPredictions = 0;
const statusEl = document.getElementById('status');
const labelContainer = document.getElementById('label-container');

function setStatus(text, busy=false){
  statusEl.innerHTML = (busy? '<span class="spinner"></span>' : '') + text;
}

// ë™ì ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (Promise)
function loadScript(src){
  return new Promise((resolve, reject) => {
    // ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
    if(document.querySelector(`script[src="${src}"]`)) return resolve();
    const s = document.createElement('script');
    s.src = src;
    s.onload = () => resolve();
    s.onerror = (e) => reject(new Error('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + src));
    document.head.appendChild(s);
  });
}

// tmImage ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ tfjs ì§€ì—°ë¡œë“œ
async function ensureTmImageLoaded(){
  if(tmImageLibLoaded) return;
  setStatus('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì¤‘...', true);

  try{
    // êµ¬ì²´ì  ë²„ì „ìœ¼ë¡œ ê³ ì •í•˜ë©´ ë¶ˆí•„ìš”í•œ ìµœì‹  ë²„ì „ ì²´í¬ë¥¼ í”¼í•  ìˆ˜ ìˆìŒ
    await loadScript('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js');
    await loadScript('https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js');
    tmImageLibLoaded = true;
    setStatus('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ. ëª¨ë¸ ì¤€ë¹„ í•„ìš”.');
  }catch(err){
    console.error(err);
    setStatus('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨ â€” ì½˜ì†” í™•ì¸', false);
    throw err;
  }
}

// ëª¨ë¸ ë¡œë“œ (í•œ ë²ˆë§Œ)
async function loadModelIfNeeded(){
  if(model) return;
  setStatus('ëª¨ë¸ ë¡œë“œ ì¤‘...', true);
  try{
    const modelURL = TM_URL + 'model.json';
    const metadataURL = TM_URL + 'metadata.json';
    model = await window.tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();
    setStatus('ëª¨ë¸ ë¡œë“œ ì™„ë£Œ. ì›¹ìº /ì—…ë¡œë“œë¡œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.');
  }catch(err){
    console.error(err);
    setStatus('ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ â€” ë„¤íŠ¸ì›Œí¬/URL í™•ì¸', false);
    throw err;
  }
}

// ì›¹ìº  ì‹œì‘ (í•´ìƒë„ ë‚®ì¶¤ -> ì†ë„ í–¥ìƒ)
async function startWebcam(){
  try{
    await ensureTmImageLoaded();
    await loadModelIfNeeded();

    // ì¤€ë¹„ëœ ë¼ë²¨ UI ì´ˆê¸°í™”
    labelContainer.innerHTML = '';
    for(let i=0;i<maxPredictions;i++) labelContainer.appendChild(document.createElement('div'));

    const flip = true;
    // í•´ìƒë„ ë‚®ê²Œ: 224x224 (ë¹ ë¦„)
    webcam = new window.tmImage.Webcam(224, 224, flip);
    await webcam.setup(); // ê¶Œí•œ ìš”ì²­
    await webcam.play();
    document.getElementById('webcam-container').innerHTML = '';
    document.getElementById('webcam-container').appendChild(webcam.canvas);
    document.getElementById('preview-img').style.display = 'none';
    setStatus('ì›¹ìº  ì‹¤í–‰ ì¤‘ â€” ëª¨ë¸ ì˜ˆì¸¡ ì¤‘...', true);
    window.requestAnimationFrame(webcamLoop);
  }catch(err){
    console.error(err);
    setStatus('ì›¹ìº  ì‹œì‘ ì‹¤íŒ¨ â€” ì½˜ì†” í™•ì¸', false);
  }
}

async function webcamLoop(){
  try{
    webcam.update();
    await predict(webcam.canvas);
    window.requestAnimationFrame(webcamLoop);
  }catch(err){
    console.error(err);
    setStatus('ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', false);
  }
}

async function predict(inputElement){
  if(!model) return;
  const prediction = await model.predict(inputElement);
  for(let i=0;i<maxPredictions;i++){
    const p = prediction[i];
    labelContainer.childNodes[i].innerHTML = `${p.className}: ${p.probability.toFixed(2)}`;
  }
}

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
document.getElementById('imgFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    await ensureTmImageLoaded();
    await loadModelIfNeeded();

    // ë¼ë²¨ ì´ˆê¸°í™”
    labelContainer.innerHTML = '';
    for(let i=0;i<maxPredictions;i++) labelContainer.appendChild(document.createElement('div'));

    const img = document.getElementById('preview-img');
    img.src = URL.createObjectURL(file);
    img.style.display = 'block';
    document.getElementById('webcam-container').innerHTML = '';
    setStatus('ì—…ë¡œë“œ ì´ë¯¸ì§€ ì˜ˆì¸¡ ì¤‘...', true);

    img.onload = async () => {
      await predict(img);
      setStatus('ì´ë¯¸ì§€ ì˜ˆì¸¡ ì™„ë£Œ', false);
    };
  }catch(err){
    console.error(err);
    setStatus('ì´ë¯¸ì§€ ì˜ˆì¸¡ ì‹¤íŒ¨ â€” ì½˜ì†” í™•ì¸', false);
  }
});

// ë²„íŠ¼ í•¸ë“¤ë§
document.getElementById('btn-start').addEventListener('click', async ()=>{
  // ë§Œì•½ ì´ë¯¸ webcamì´ ì‹¤í–‰ì¤‘ì´ë©´ ì¤‘ì§€í•˜ê³  ë‹¤ì‹œ ì‹œì‘í•˜ê²Œ í•  ìˆ˜ë„ ìˆìŒ
  startWebcam();
});
document.getElementById('btn-upload').addEventListener('click', ()=> document.getElementById('imgFile').click());

/* ë””ë²„ê¹… íŒ:
 - ë¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ì˜¤ë¥˜ ë©”ì‹œì§€ í™•ì¸
 - Network íƒ­ì—ì„œ model.json, metadata.json, tf.min.js íŒŒì¼ ìƒíƒœ í™•ì¸
 - Mixed Content: í˜ì´ì§€ê°€ httpsì¸ë° ëª¨ë¸ì´ httpì´ë©´ ì°¨ë‹¨ë¨
 - getUserMedia ì—ëŸ¬: "NotAllowedError" (ê¶Œí•œ ê±°ë¶€) ë˜ëŠ” "NotReadableError"
*/
setStatus('ì¤€ë¹„ë¨', false);
</script>
</body>
</html>

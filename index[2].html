<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teachable Machine - Image Classifier</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f7ff;
      text-align: center;
      padding: 20px;
    }
    h1 { color: #333; }

    video, img {
      width: 300px;
      border-radius: 15px;
      margin-top: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
    }

    #buttons { margin-top: 20px; }

    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      background: #4a6cff;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    #result {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
    }
  </style>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
</head>

<body>
  <h1>Teachable Machine (Webcam + File)</h1>

  <div id="buttons">
    <button onclick="switchMode('webcam')">ðŸ“¸ Webcam Mode</button>
    <button onclick="switchMode('file')">ðŸ–¼ File Upload Mode</button>
  </div>

  <!-- Webcam -->
  <video id="webcam" autoplay playsinline style="display:none;"></video>

  <!-- Image preview -->
  <img id="preview" style="display:none;">

  <input 
    id="fileInput" 
    type="file" 
    accept="image/*" 
    onchange="onFileSelected(event)" 
    style="display:none; margin-top:20px;"
  >

  <div id="result">Loading model...</div>

  <script>
    let model;
    const URL = "./";
    let webcamStream = null;
    let currentMode = "file";

    const webcamElement = document.getElementById("webcam");
    const previewImg = document.getElementById("preview");
    const resultBox = document.getElementById("result");
    const fileInput = document.getElementById("fileInput");

    async function initModel() {
      model = await tmImage.load(URL + "model.json", URL + "metadata.json");
      resultBox.innerText = "Model loaded!";
    }

    function switchMode(mode) {
      currentMode = mode;

      if (mode === "webcam") {
        startWebcam();
        previewImg.style.display = "none";
        fileInput.style.display = "none";
        webcamElement.style.display = "block";
      } else {
        stopWebcam();
        webcamElement.style.display = "none";
        previewImg.style.display = "block";
        fileInput.style.display = "block";
        resultBox.innerText = "Upload an image.";
      }
    }

    // File upload
    function onFileSelected(event) {
      const file = event.target.files[0];
      if (!file) return;

      previewImg.src = URL.createObjectURL(file);
      previewImg.onload = () => predict(previewImg);
    }

    // Webcam ON
    async function startWebcam() {
      if (webcamStream) return;

      webcamStream = await navigator.mediaDevices.getUserMedia({
        video: { width: 256, height: 256 },
        audio: false
      });
      webcamElement.srcObject = webcamStream;
      webcamElement.addEventListener("loadeddata", webcamLoop);
    }

    function stopWebcam() {
      if (webcamStream) {
        webcamStream.getTracks().forEach(track => track.stop());
        webcamStream = null;
      }
    }

    async function webcamLoop() {
      if (currentMode !== "webcam") return;
      await predict(webcamElement);
      requestAnimationFrame(webcamLoop);
    }

    async function predict(source) {
      if (!model) return;

      const prediction = await model.predict(source);
      prediction.sort((a, b) => b.probability - a.probability);

      const top = prediction[0];
      resultBox.innerText =
        `Result: ${top.className} (${(top.probability * 100).toFixed(1)}%)`;
    }

    initModel();
    switchMode("file");
  </script>

</body>
</html>
